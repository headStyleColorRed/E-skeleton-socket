<html>

<head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.9-1/crypto-js.js"></script>
    <script>
        let chatRoomId = "29eihcf892q"
        let userId = "B8CC43BA-514B"
        var ws = null

        function init() {
            function printReceivedMessage(data) {
                var element = document.getElementById("debug");
                var p = document.createElement("p");


                if (data["sender"] == undefined) {
                    p.appendChild(document.createTextNode(`>${data}`));
                } else {
                    p.appendChild(document.createTextNode(`>${data.sender.name}: ${decryptMessage(data.message)}`));
                }
                element.appendChild(p);
            }

            var Socket = "MozWebSocket" in window ? MozWebSocket : WebSocket;

            ws = new Socket(`ws://localhost:9006/${chatRoomId}?userId=${userId}`);
            ws.onmessage = function (evt) {
                console.log("New message");
                console.log(evt.data);
                let receivedData = JSON.parse(evt.data)
                console.log("Parsed message");
                console.log(receivedData);
                if (receivedData.receiptAuthor != undefined) {
                    console.log("Receival")
                    console.log(receivedData)
                } else {
                    printReceivedMessage(receivedData);
                    sendReceival(receivedData)
                }
            };
            ws.onclose = function (event) {
                printReceivedMessage("Closed - code: " + event.code + ", reason: " + event.reason + ", wasClean: " + event.wasClean);
            };
            ws.onopen = function () {
                printReceivedMessage("connected...");
            };
        };

        function sendMessage() {
            console.log("sending mesage");
            var element = document.getElementById("inputText")

            let newMessage = {
                "date": "2021-11-09 20:52:16",
                "id": Math.random().toString(36).substr(2, 9),
                "message": element.value,
                "sender": {
                    "id": userId,
                    "name": "Ana"
                },
                "chatroom": chatRoomId,
                "status": "none"
            }
            let stringifiedMessage = JSON.stringify(newMessage)
            console.log(stringifiedMessage);
            ws.send(stringifiedMessage)
            element.value = new String()
        }

        function sendReceival(receivedData) {
            console.log("sending receival");
            let receipt = {
                "messageId": receivedData.id,
                "sender": {
                    "id": receivedData.sender.id,
                    "name": receivedData.sender.name
                },
                "receiptAuthor": "user",
                "chatroom": receivedData.chatroom
            }

            let stringifiedMessage = JSON.stringify(receipt)
            ws.send(stringifiedMessage)
        }

        function decryptMessage(message) {
            var key = CryptoJS.enc.Utf8.parse('ccC2H19lDDbQDfakxcrtNMQdd0FloLGG');     // Use Utf8-Encoder. 
            var iv = CryptoJS.enc.Utf8.parse('ggGGHUiDD0Qjhuvv');                     // Use Utf8-Encoder

            var decryptedWA = CryptoJS.AES.decrypt(message, key, { iv: iv });
            var decryptedUtf8 = decryptedWA.toString(CryptoJS.enc.Utf8);
            return decryptedUtf8
        }

    </script>
</head>

<body onload="init();">
    <div id="debug"></div>
    <input type="text" id="inputText">
    <button onclick="sendMessage()">Send</button>
</body>

</html>