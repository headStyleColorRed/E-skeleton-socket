<html>

<head>
  <script>
    let chatRoomId = "29eihcf892q"
    let userId = "B8CC43BA-514B"
    var ws = null
 
    function init() {
      function printReceivedMessage(data) {
        var element = document.getElementById("debug");
        var p = document.createElement("p");


        if (data["sender"] == undefined) {
          p.appendChild(document.createTextNode(`>${data}`));
        } else {
          p.appendChild(document.createTextNode(`>${data.sender.name}: ${data.message}`));
        }
        element.appendChild(p);
      }

      var Socket = "MozWebSocket" in window ? MozWebSocket : WebSocket;

      ws = new Socket(`ws://localhost:9006/${chatRoomId}?userId=${userId}`);
      ws.onmessage = function (evt) {
        let receivedData = JSON.parse(evt.data)
        if (receivedData.receiptAuthor != undefined) {
          console.log("Receival")
          console.log(receivedData)
        } else {
          printReceivedMessage(receivedData);
          sendReceival(receivedData)
        }
      };
      ws.onclose = function (event) {
        printReceivedMessage("Closed - code: " + event.code + ", reason: " + event.reason + ", wasClean: " + event.wasClean);
      };
      ws.onopen = function () {
        printReceivedMessage("connected...");
      };
    };

    function sendMessage() {
      var element = document.getElementById("inputText")

      let newMessage = {
        "date": "2021-11-09 20:52:16",
        "id": Math.random().toString(36).substr(2, 9),
        "message": element.value,
        "sender": {
          "id": userId,
          "name": "Ana"
        },
        "chatroom": chatRoomId,
        "status": "none"
      }
      let stringifiedMessage = JSON.stringify(newMessage)
      console.log(stringifiedMessage);
      ws.send(stringifiedMessage)
      element.value = new String()
    }

    function sendReceival(messageId) {
      let receipt = {
        "messageId": receivedData.id,
        "sender": {
          "id": receivedData.sender.id,
          "name": receivedData.sender.name
        },
        "receiptAuthor": "user",
        "chatroom": receivedData.chatRoomId
      }


      let stringifiedMessage = JSON.stringify(receipt)
      ws.send(stringifiedMessage)
    }

  </script>
</head>

<body onload="init();">
  <div id="debug"></div>
  <input type="text" id="inputText">
  <button onclick="sendMessage()">Send</button>
</body>

</html>